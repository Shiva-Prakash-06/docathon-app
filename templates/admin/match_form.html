{% extends "base.html" %}
{% set page_title = form_title %}

{% block content %}
<div class="d-flex justify-content-between align-items-center">
    <h1>{{ form_title }}</h1>
    {% if match %}
    <form action="{{ url_for('delete_match', match_id=match.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this match permanently?');">
        <button type="submit" class="btn btn-outline-danger">Delete Match</button>
    </form>
    {% endif %}
</div>

<div class="card mt-4">
    <div class="card-body">
        <form method="POST">
            {% if not match %}
            <div class="mb-3">
                <label for="round_id" class="form-label">Select Round</label>
                <select class="form-select" id="round_id" name="round_id" required>
                    <option value="" disabled selected>Select a round...</option>
                    {% for sport, rounds_in_sport in rounds|groupby('sport_name') %}
                        <optgroup label="{{ sport }}">
                            {% for round in rounds_in_sport %}
                                <option value="{{ round.id }}">{{ round.name }}</option>
                            {% endfor %}
                        </optgroup>
                    {% endfor %}
                </select>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="class1_id" class="form-label">Team 1</label>
                    <select class="form-select" id="class1_id" name="class1_id" required>
                        <option value="" disabled selected>Select first team...</option>
                        {% for class in classes %}
                        <option value="{{ class.id }}">{{ class.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="class2_id" class="form-label">Team 2</label>
                    <select class="form-select" id="class2_id" name="class2_id" required>
                        <option value="" disabled selected>Select second team...</option>
                        {% for class in classes %}
                        <option value="{{ class.id }}">{{ class.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label for="match_time" class="form-label">Match Date and Time</label>
                <input type="datetime-local" class="form-control" id="match_time" name="match_time" value="{{ default_time }}" required>
            </div>
            
            {% else %}
            <h5 class="mb-3">{{ match.sport_name }}: {{ match.class1_name }} vs {{ match.class2_name }}</h5>
            
            <div class="mb-3">
                <label for="status" class="form-label">Match Status</label>
                <select class="form-select" id="status" name="status">
                    <option value="UPCOMING" {% if match.status == 'UPCOMING' %}selected{% endif %}>Upcoming</option>
                    <option value="LIVE" {% if match.status == 'LIVE' %}selected{% endif %}>LIVE</option>
                    <option value="COMPLETED" {% if match.status == 'COMPLETED' %}selected{% endif %}>Completed</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label for="result_details" class="form-label">Result Details</label>
                <input type="text" class="form-control" id="result_details" name="result_details" value="{{ match.result_details or '' }}" placeholder="e.g., 2-1, 150/7, 21-18">
            </div>

            <div class="mb-3">
                <label for="winner_id" class="form-label">Winner</label>
                <select class="form-select" id="winner_id" name="winner_id">
                    <option value="">-- No Winner Yet --</option>
                    <option value="{{ match.class1_id }}" {% if match.winner_id == match.class1_id %}selected{% endif %}>{{ match.class1_name }}</option>
                    <option value="{{ match.class2_id }}" {% if match.winner_id == match.class2_id %}selected{% endif %}>{{ match.class2_name }}</option>
                </select>
                <div class="form-text">Select a winner only if the status is 'Completed'.</div>
            </div>

            <div class="mb-3">
                <label for="notes" class="form-label">Notes (Optional)</label>
                <textarea class="form-control" id="notes" name="notes" rows="3">{{ match.notes or '' }}</textarea>
            </div>
            {% endif %}
            
            <div class="d-flex justify-content-end">
                <a href="{{ url_for('list_matches') }}" class="btn btn-secondary me-2">Cancel</a>
                <button type="submit" class="btn btn-warning">Save Changes</button>
            </div>
        </form>

        {% if match and match.status != 'COMPLETED' %}
        <hr class="my-4">
        <div>
            <h5 class="mb-3">Declare Walkover</h5>
            <p class="text-muted">This will mark the match as completed and apply a -3 point penalty to the losing team.</p>
            <div class="d-flex gap-2">
                <form action="{{ url_for('declare_walkover', match_id=match.id) }}" method="POST">
                    <input type="hidden" name="loser_id" value="{{ match.class1_id }}">
                    <button type="submit" class="btn btn-outline-info">Declare '{{ match.class2_name }}' as Winner</button>
                </form>
                <form action="{{ url_for('declare_walkover', match_id=match.id) }}" method="POST">
                    <input type="hidden" name="loser_id" value="{{ match.class2_id }}">
                    <button type="submit" class="btn btn-outline-info">Declare '{{ match.class1_name }}' as Winner</button>
                </form>
            </div>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}