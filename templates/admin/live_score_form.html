{% extends "base.html" %}
{% set page_title = "Live Score: " + match.sport_name %}

{% block content %}
<style>
    .score-controls .btn-group { display: flex; flex-wrap: wrap; justify-content: center; }
    .score-controls .btn { margin: 4px; }
    .set-table { max-width: 400px; margin: 20px auto; }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{{ url_for('list_matches') }}">&larr; Back to All Matches</a>
        <h1 class="display-5">{{ match.sport_name }}</h1>
        <p class="lead text-muted">{{ match.round_name }}</p>
    </div>
    <div class="d-flex gap-2">
        <form action="{{ url_for('undo_last_event', match_id=match.id) }}" method="POST">
            <button type="submit" class="btn btn-lg btn-secondary">Undo Last Event</button>
        </form>
        <form action="{{ url_for('finalize_match', match_id=match.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to finalize this match?');">
            <button type="submit" class="btn btn-lg btn-success">Finalize Match</button>
        </form>
    </div>
</div>

{# POINT-BASED SCORING INTERFACE (Cricket, Basketball, etc.) #}
{% if score_format == 'points' %}
<div class="card bg-dark border-secondary">
    <div class="card-body p-4">
        <div class="row align-items-center text-center">
            <div class="col-5">
                <h2 class="h3">{{ match.class1_name }}</h2>
                <p class="display-1 fw-bold text-warning">
                    <span id="score-{{ match.class1_id }}">{{ scores[match.class1_id].score }}</span>
                    {% if is_cricket %}/<span id="wickets-{{ match.class1_id }}">{{ scores[match.class1_id].wickets }}</span>{% endif %}
                </p>
                {% if is_cricket %}
                <p class="text-muted h5">Overs: <span id="overs-{{ match.class1_id }}">{{ scores[match.class1_id].overs }}</span>.<span id="balls-{{ match.class1_id }}">{{ scores[match.class1_id].balls }}</span></p>
                {% endif %}
            </div>
            <div class="col-2"><span class="display-4 text-muted">VS</span></div>
            <div class="col-5">
                <h2 class="h3">{{ match.class2_name }}</h2>
                <p class="display-1 fw-bold text-warning">
                    <span id="score-{{ match.class2_id }}">{{ scores[match.class2_id].score }}</span>
                    {% if is_cricket %}/<span id="wickets-{{ match.class2_id }}">{{ scores[match.class2_id].wickets }}</span>{% endif %}
                </p>
                {% if is_cricket %}
                <p class="text-muted h5">Overs: <span id="overs-{{ match.class2_id }}">{{ scores[match.class2_id].overs }}</span>.<span id="balls-{{ match.class2_id }}">{{ scores[match.class2_id].balls }}</span></p>
                {% endif %}
            </div>
        </div>
        <hr class="my-4">
        <div class="row text-center">
            <div class="col-6 border-end border-secondary score-controls">
                <h4 class="mb-3">Score for {{ match.class1_name }}</h4>
                <div class="btn-group" role="group" id="team-{{ match.class1_id }}-controls">
                    {% for button in buttons %}
                    <button class="btn btn-outline-warning btn-lg score-btn"
                            data-team-id="{{ match.class1_id }}"
                            data-is-complex="{{ button.isComplex|tojson }}"
                            data-event='{{ button|tojson|forceescape }}'>
                        {{ button.label }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            <div class="col-6 score-controls">
                <h4 class="mb-3">Score for {{ match.class2_name }}</h4>
                <div class="btn-group" role="group" id="team-{{ match.class2_id }}-controls">
                    {% for button in buttons %}
                    <button class="btn btn-outline-warning btn-lg score-btn"
                            data-team-id="{{ match.class2_id }}"
                            data-is-complex="{{ button.isComplex|tojson }}"
                            data-event='{{ button|tojson|forceescape }}'>
                        {{ button.label }}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{# DETAILED SET-BASED SCORING INTERFACE (Volleyball, Throwball) #}
{% elif score_format == 'sets_detailed' %}
<div class="card bg-dark border-secondary">
    <div class="card-body p-4 text-center">
        <div class="row align-items-center">
            <div class="col-5">
                <h2 class="h3">{{ match.class1_name }}</h2>
                <p class="display-1 fw-bold text-warning" id="sets-won-{{ match.class1_id }}">{{ scores.sets_won[match.class1_id] }}</p>
                <small class="text-muted">Sets Won</small>
            </div>
            <div class="col-2"><span class="display-4 text-muted">VS</span></div>
            <div class="col-5">
                <h2 class="h3">{{ match.class2_name }}</h2>
                <p class="display-1 fw-bold text-warning" id="sets-won-{{ match.class2_id }}">{{ scores.sets_won[match.class2_id] }}</p>
                <small class="text-muted">Sets Won</small>
            </div>
        </div>
        <hr>
        <h5 class="mt-4">Current Set Score</h5>
        <div class="row align-items-center fs-1">
             <div class="col-5"><span id="current-score-{{ match.class1_id }}">{{ scores.current_set_scores[match.class1_id] }}</span></div>
             <div class="col-2"><span class="text-muted">-</span></div>
             <div class="col-5"><span id="current-score-{{ match.class2_id }}">{{ scores.current_set_scores[match.class2_id] }}</span></div>
        </div>
        <div class="row text-center mt-3">
            <div class="col-6 border-end border-secondary">
                <button class="btn btn-outline-warning btn-lg score-btn-set" data-team-id="{{ match.class1_id }}">+1</button>
            </div>
            <div class="col-6">
                <button class="btn btn-outline-warning btn-lg score-btn-set" data-team-id="{{ match.class2_id }}">+1</button>
            </div>
        </div>
        <form action="{{ url_for('end_set') }}" method="POST" class="mt-4">
             <input type="hidden" name="match_id" value="{{ match.id }}">
             <button type="submit" class="btn btn-info">Finalize Current Set</button>
        </form>
        {% if scores.completed_sets %}
        <table class="table table-dark table-bordered set-table mt-4">
            <thead><tr><th>Set</th><th>{{ match.class1_name }}</th><th>{{ match.class2_name }}</th></tr></thead>
            <tbody>
                {% for set_score in scores.completed_sets %}
                <tr><td>{{ loop.index }}</td><td>{{ set_score[match.class1_id] }}</td><td>{{ set_score[match.class2_id] }}</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>
{% endif %}


<div class="card bg-dark border-secondary mt-4">
    <div class="card-body">
        <h5 class="card-title">Log a Manual Event</h5>
        <form action="{{ url_for('log_manual_event', match_id=match.id) }}" method="POST">
            <div class="row g-2">
                <div class="col-md-4">
                    <select name="team_id" class="form-select" required>
                        <option value="" disabled selected>-- Select Team --</option>
                        <option value="{{ match.class1_id }}">{{ match.class1_name }}</option>
                        <option value="{{ match.class2_id }}">{{ match.class2_name }}</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <input type="text" name="event_description" class="form-control" placeholder="e.g., Yellow Card, Great Save" required>
                </div>
                <div class="col-md-2 d-grid">
                    <button type="submit" class="btn btn-info">Log Event</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const scoreFormat = "{{ score_format }}";
    const matchId = {{ match.id }};
    const isCricket = {{ is_cricket|tojson }};
    const team1Id = {{ match.class1_id }};
    const team2Id = {{ match.class2_id }};
    let activeComplexEvent = null;

    const runButtons = [
        {'label': '+0', 'points': 0, 'type': 'Runs', 'counts_as_ball': 1},
        {'label': '+1', 'points': 1, 'type': 'Runs', 'counts_as_ball': 1},
        {'label': '+2', 'points': 2, 'type': 'Runs', 'counts_as_ball': 1},
        {'label': '+3', 'points': 3, 'type': 'Runs', 'counts_as_ball': 1},
        {'label': '+4', 'points': 4, 'type': 'Runs', 'counts_as_ball': 1},
        {'label': '+6', 'points': 6, 'type': 'Runs', 'counts_as_ball': 1},
    ];

    // --- SHARED HELPER FUNCTIONS ---
    async function sendRequest(url, body) {
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            if (!response.ok) throw new Error('Network response was not ok');
            return await response.json();
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to update score.');
        }
    }
    
    function updateScoreDisplay(data) {
        if (scoreFormat === 'points') {
            document.getElementById(`score-${data.team_id}`).textContent = data.new_total;
            if (isCricket) {
                document.getElementById(`wickets-${data.team_id}`).textContent = data.new_wickets;
                document.getElementById(`overs-${data.team_id}`).textContent = data.new_overs;
                document.getElementById(`balls-${data.team_id}`).textContent = data.new_balls;
            }
        } else if (scoreFormat === 'sets_detailed') {
            document.getElementById(`current-score-${team1Id}`).textContent = data.new_scores.current_set_scores[team1Id];
            document.getElementById(`current-score-${team2Id}`).textContent = data.new_scores.current_set_scores[team2Id];
        }
    }

    // --- POINT-BASED SCORING LOGIC ---
    if (scoreFormat === "points") {
        function resetControls(teamId) {
            const controlDiv = document.getElementById(`team-${teamId}-controls`);
            controlDiv.innerHTML = '';
            const originalButtons = {{ buttons|tojson }};
            originalButtons.forEach(buttonData => {
                const button = document.createElement('button');
                button.className = 'btn btn-outline-warning btn-lg score-btn';
                button.dataset.teamId = teamId;
                button.dataset.isComplex = buttonData.isComplex;
                button.dataset.event = JSON.stringify(buttonData);
                button.textContent = buttonData.label;
                controlDiv.appendChild(button);
            });
            activeComplexEvent = null;
            addEventListenersToButtons();
        }

        function showRunButtons(teamId, baseEvent) {
            activeComplexEvent = { teamId, baseEvent };
            const controlDiv = document.getElementById(`team-${teamId}-controls`);
            controlDiv.innerHTML = `<span class="text-warning me-2">Runs on ${baseEvent.type}?</span>`;

            runButtons.forEach(runData => {
                const button = document.createElement('button');
                button.className = 'btn btn-outline-info btn-lg';
                button.textContent = runData.label;
                button.onclick = async () => {
                    const body = {
                        match_id: matchId, team_id: teamId,
                        base_event: baseEvent, extra_runs: runData
                    };
                    const data = await sendRequest('{{ url_for("log_complex_event") }}', body);
                    if(data) updateScoreDisplay(data);
                    resetControls(teamId);
                };
                controlDiv.appendChild(button);
            });
        }

        function handleButtonClick(event) {
            const button = event.target;
            const teamId = button.dataset.teamId;
            const isComplex = button.dataset.isComplex === 'true';
            const eventData = JSON.parse(button.dataset.event);

            if (isComplex) {
                showRunButtons(teamId, eventData);
            } else {
                const body = {
                    match_id: matchId, team_id: teamId,
                    points: eventData.points, event_type: eventData.type,
                    counts_as_ball: eventData.counts_as_ball
                };
                sendRequest('{{ url_for("add_score") }}', body).then(data => {
                    if (data) updateScoreDisplay(data);
                });
            }
        }

        function addEventListenersToButtons() {
            document.querySelectorAll('.score-btn').forEach(button => {
                button.addEventListener('click', handleButtonClick);
            });
        }
        addEventListenersToButtons();
    }
    
    // --- SET-BASED SCORING LOGIC ---
    else if (scoreFormat === "sets_detailed") {
        document.querySelectorAll('.score-btn-set').forEach(button => {
            button.addEventListener('click', async () => {
                const teamId = button.dataset.teamId;
                const body = {
                    match_id: matchId, team_id: teamId,
                    points: 1, event_type: 'Point', counts_as_ball: 0
                };
                // We reuse the 'add_score' endpoint, but need a different API to get set scores back
                const data = await sendRequest('{{ url_for("add_score_set") }}', body);
                if (data) updateScoreDisplay(data);
            });
        });
    }
});
</script>
{% endblock %}