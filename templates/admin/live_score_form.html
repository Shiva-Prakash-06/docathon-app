{% extends "base.html" %}
{% set page_title = "Live Score: " + match.sport_name %}

{% block content %}
<style>
    .score-controls .btn-group {
        display: flex;
        flex-wrap: wrap; /* Allows buttons to wrap to the next line */
        justify-content: center;
    }
    .score-controls .btn {
        margin: 4px; /* Adds spacing between buttons */
    }
</style>
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{{ url_for('list_matches') }}">&larr; Back to All Matches</a>
        <h1 class="display-5">{{ match.sport_name }}</h1>
        <p class="lead text-muted">{{ match.round_name }}</p>
    </div>
    <div class="d-flex gap-2">
        <form action="{{ url_for('undo_last_event', match_id=match.id) }}" method="POST">
            <button type="submit" class="btn btn-lg btn-secondary">Undo Last Event</button>
        </form>
        <form action="{{ url_for('finalize_match', match_id=match.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to finalize this match? This will set the winner and complete the match.');">
            <button type="submit" class="btn btn-lg btn-success">Finalize Match</button>
        </form>
    </div>
</div>

<div class="card bg-dark border-secondary">
    <div class="card-body p-4">
        <div class="row align-items-center text-center">
            <div class="col-5">
                <h2 class="h3">{{ match.class1_name }}</h2>
                <p class="display-1 fw-bold text-warning">
                    <span id="score-{{ match.class1_id }}">{{ scores[match.class1_id].score }}</span>
                    {% if is_cricket %}/<span id="wickets-{{ match.class1_id }}">{{ scores[match.class1_id].wickets }}</span>{% endif %}
                </p>
                {% if is_cricket %}
                <p class="text-muted h5">
                    Overs: <span id="overs-{{ match.class1_id }}">{{ scores[match.class1_id].overs }}</span>.<span id="balls-{{ match.class1_id }}">{{ scores[match.class1_id].balls }}</span>
                </p>
                {% endif %}
            </div>
            <div class="col-2"><span class="display-4 text-muted">VS</span></div>
            <div class="col-5">
                <h2 class="h3">{{ match.class2_name }}</h2>
                <p class="display-1 fw-bold text-warning">
                    <span id="score-{{ match.class2_id }}">{{ scores[match.class2_id].score }}</span>
                    {% if is_cricket %}/<span id="wickets-{{ match.class2_id }}">{{ scores[match.class2_id].wickets }}</span>{% endif %}
                </p>
                {% if is_cricket %}
                <p class="text-muted h5">
                    Overs: <span id="overs-{{ match.class2_id }}">{{ scores[match.class2_id].overs }}</span>.<span id="balls-{{ match.class2_id }}">{{ scores[match.class2_id].balls }}</span>
                </p>
                {% endif %}
            </div>
        </div>
        <hr class="my-4">
        <div class="row text-center">
            <div class="col-6 border-end border-secondary score-controls">
                <h4 class="mb-3">Score for {{ match.class1_name }}</h4>
                <div class="btn-group" role="group" id="team-{{ match.class1_id }}-controls">
                    {% for button in buttons %}
                    <button class="btn btn-outline-warning btn-lg score-btn"
                            data-team-id="{{ match.class1_id }}"
                            data-is-complex="{{ button.isComplex|tojson }}"
                            data-event='{{ button|tojson|forceescape }}'>
                        {{ button.label }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            <div class="col-6 score-controls">
                <h4 class="mb-3">Score for {{ match.class2_name }}</h4>
                <div class="btn-group" role="group" id="team-{{ match.class2_id }}-controls">
                    {% for button in buttons %}
                    <button class="btn btn-outline-warning btn-lg score-btn"
                            data-team-id="{{ match.class2_id }}"
                            data-is-complex="{{ button.isComplex|tojson }}"
                            data-event='{{ button|tojson|forceescape }}'>
                        {{ button.label }}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card bg-dark border-secondary mt-4">
    <div class="card-body">
        <h5 class="card-title">Log a Manual Event</h5>
        <form action="{{ url_for('log_manual_event', match_id=match.id) }}" method="POST">
            <div class="row g-2">
                <div class="col-md-4">
                    <select name="team_id" class="form-select" required>
                        <option value="" disabled selected>-- Select Team --</option>
                        <option value="{{ match.class1_id }}">{{ match.class1_name }}</option>
                        <option value="{{ match.class2_id }}">{{ match.class2_name }}</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <input type="text" name="event_description" class="form-control" placeholder="e.g., Yellow Card, Great Save" required>
                </div>
                <div class="col-md-2 d-grid">
                    <button type="submit" class="btn btn-info">Log Event</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const matchId = {{ match.id }};
    const isCricket = {{ is_cricket|tojson }};
    let activeComplexEvent = null;

    const runButtons = [
        {'label': '+0', 'points': 0, 'type': 'Runs', 'counts_as_ball': 1},
        {'label': '+1', 'points': 1, 'type': 'Runs', 'counts_as_ball': 1},
        {'label': '+2', 'points': 2, 'type': 'Runs', 'counts_as_ball': 1},
        {'label': '+3', 'points': 3, 'type': 'Runs', 'counts_as_ball': 1},
        {'label': '+4', 'points': 4, 'type': 'Runs', 'counts_as_ball': 1},
        {'label': '+6', 'points': 6, 'type': 'Runs', 'counts_as_ball': 1},
    ];

    function updateScoreDisplay(data) {
        document.getElementById(`score-${data.team_id}`).textContent = data.new_total;
        if (isCricket) {
            document.getElementById(`wickets-${data.team_id}`).textContent = data.new_wickets;
            document.getElementById(`overs-${data.team_id}`).textContent = data.new_overs;
            document.getElementById(`balls-${data.team_id}`).textContent = data.new_balls;
        }
    }

    async function sendRequest(url, body) {
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            updateScoreDisplay(data);
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to update score.');
        }
    }

    function resetControls(teamId) {
        const controlDiv = document.getElementById(`team-${teamId}-controls`);
        controlDiv.innerHTML = '';
        const originalButtons = {{ buttons|tojson }};
        originalButtons.forEach(buttonData => {
            const button = document.createElement('button');
            button.className = 'btn btn-outline-warning btn-lg score-btn';
            button.dataset.teamId = teamId;
            button.dataset.isComplex = buttonData.isComplex;
            button.dataset.event = JSON.stringify(buttonData);
            button.textContent = buttonData.label;
            controlDiv.appendChild(button);
        });
        activeComplexEvent = null;
        addEventListenersToButtons();
    }

    function showRunButtons(teamId, baseEvent) {
        activeComplexEvent = { teamId, baseEvent };
        const controlDiv = document.getElementById(`team-${teamId}-controls`);
        controlDiv.innerHTML = `<span class="text-warning me-2">Runs on ${baseEvent.type}?</span>`;

        runButtons.forEach(runData => {
            const button = document.createElement('button');
            button.className = 'btn btn-outline-info btn-lg';
            button.textContent = runData.label;
            button.onclick = () => {
                const body = {
                    match_id: matchId,
                    team_id: teamId,
                    base_event: baseEvent,
                    extra_runs: runData
                };
                sendRequest('{{ url_for("log_complex_event") }}', body);
                resetControls(teamId);
            };
            controlDiv.appendChild(button);
        });
    }

    function handleButtonClick(event) {
        const button = event.target;
        const teamId = button.dataset.teamId;
        const isComplex = button.dataset.isComplex === 'true';
        const eventData = JSON.parse(button.dataset.event);

        if (isComplex) {
            showRunButtons(teamId, eventData);
        } else {
            const body = {
                match_id: matchId, team_id: teamId,
                points: eventData.points, event_type: eventData.type,
                counts_as_ball: eventData.counts_as_ball
            };
            sendRequest('{{ url_for("add_score") }}', body);
        }
    }

    function addEventListenersToButtons() {
        document.querySelectorAll('.score-btn').forEach(button => {
            button.addEventListener('click', handleButtonClick);
        });
    }

    addEventListenersToButtons();
});
</script>
{% endblock %}